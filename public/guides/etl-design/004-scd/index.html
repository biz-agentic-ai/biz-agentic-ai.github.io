<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가 | Junho Lee | DataNexus 구축 과정</title>
<meta name="keywords" content="etl, scd, dbt-snapshot">
<meta name="description" content="차원 데이터가 바뀌면 과거를 덮어쓸 것인가, 이력을 남길 것인가. SCD Type 1, 2, 3의 차이를 SQL로 직접 구현하고, dbt snapshot으로 프로덕션 패턴을 만든다.">
<meta name="author" content="Junho Lee">
<link rel="canonical"
    href="https://biz-agentic-ai.github.io/guides/etl-design/004-scd/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f02cd38532ee71bc47a8f72d7689b18efbda747f2e684f90cc6f2c90f2311a6b.css" integrity="sha256-8CzThTLucbxHqPctdomxjvvadH8uaE&#43;QzG8skPIxGms="
    rel="preload stylesheet" as="style">
<link rel="icon" href="https://biz-agentic-ai.github.io/favicon.svg">
<link rel="icon" type="image/svg+xml" sizes="16x16" href="https://biz-agentic-ai.github.io/favicon.svg">
<link rel="icon" type="image/svg+xml" sizes="32x32" href="https://biz-agentic-ai.github.io/favicon.svg">
<link rel="apple-touch-icon" href="https://biz-agentic-ai.github.io/favicon.svg">
<link rel="mask-icon" href="https://biz-agentic-ai.github.io/favicon.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://biz-agentic-ai.github.io/guides/etl-design/004-scd/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }
    </style>
</noscript><meta name="author" content="Junho Lee"><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@biz_agentic_ai">
<meta name="twitter:creator" content="@biz_agentic_ai"><meta name="googlebot" content="index, follow">
<meta name="bingbot" content="index, follow">
<meta name="slurp" content="index, follow"><meta name="language" content="ko">
<meta name="geo.region" content="KR">
<meta name="geo.placename" content="Seoul"><meta property="og:type" content="article">
<meta property="og:site_name" content="Junho Lee | DataNexus 구축 과정">
<meta property="og:locale" content="ko_KR"><script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가",
    "description": "차원 데이터가 바뀌면 과거를 덮어쓸 것인가, 이력을 남길 것인가. SCD Type 1, 2, 3의 차이를 SQL로 직접 구현하고, dbt snapshot으로 프로덕션 패턴을 만든다.",
    "image": "",
    "author": {
      "@type": "Person",
      "name": "Junho Lee"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Junho Lee | DataNexus 구축 과정",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/biz-agentic-ai.github.io\/favicon.svg"
      }
    },
    "datePublished": "2026-02-22T13:00:00\u002b09:00",
    "dateModified": "2026-02-22T13:00:00\u002b09:00",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/biz-agentic-ai.github.io\/guides\/etl-design\/004-scd\/"
    }
  }
  </script><style>
  :root {
    --sidebar-width: 260px;
    --sidebar-bg: #1a1a2e;
    --sidebar-text: #e0e0e0;
    --sidebar-accent: #667eea;
    --sidebar-hover: rgba(102, 126, 234, 0.15);
    --sidebar-active-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

   
  html {
    font-size: 15px;
  }

   
  .first-entry {
    min-height: 240px;
  }

  .first-entry .entry-header h1 {
    font-size: 24px;
  }

  .first-entry .entry-content {
    font-size: 14px;
  }

  .home-info .entry-content {
    font-size: 14px;
  }

  .entry-header h2 {
    font-size: 20px;
  }

  .entry-content {
    font-size: 13px;
  }

   
  .post-title,
  .post-single .post-title {
    font-size: 26px;
  }

  .post-content {
    font-size: 15px;
    line-height: 1.75;
  }

  .post-content h1 {
    font-size: 24px;
  }

  .post-content h2 {
    font-size: 21px;
  }

  .post-content h3 {
    font-size: 18px;
  }

  .post-content h4 {
    font-size: 16px;
  }

  .post-meta {
    font-size: 13px;
  }

  .toc a {
    font-size: 13px;
  }

  .first-entry {
    margin-top: 0;
  }

   
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--sidebar-bg);
    color: var(--sidebar-text);
    z-index: 100;
    overflow-y: auto;
    transition: transform 0.3s ease;
  }

  .sidebar-inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 24px 0;
  }

  .sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 8px;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.3rem;
    font-weight: 700;
    color: #fff;
    text-decoration: none;
    letter-spacing: -0.02em;
  }

  .sidebar-logo-img {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    object-fit: cover;
  }

  .home-logo-img {
    width: 42px;
    height: 42px;
    border-radius: 8px;
    object-fit: cover;
    vertical-align: middle;
    margin-right: 8px;
  }

  .sidebar-logo:hover {
    opacity: 0.85;
  }

  .sidebar-subtitle {
    display: block;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 2px;
    letter-spacing: 0.02em;
  }

   
  .sidebar-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-section li a {
    display: block;
    padding: 9px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    font-size: 0.88rem;
    border-left: 3px solid transparent;
    transition: all 0.2s;
  }

  .sidebar-section li a:hover {
    background: var(--sidebar-hover);
    border-left-color: var(--sidebar-accent);
    color: #fff;
  }

  .sidebar-section li a.active {
    color: var(--sidebar-accent);
    font-weight: 600;
    border-left-color: var(--sidebar-accent);
  }

   
  .sidebar-section {
    padding: 8px 0;
    margin-top: 4px;
  }

  .sidebar-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255, 255, 255, 0.4);
    padding: 8px 20px;
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .sidebar-section-title::before {
    content: "";
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .sidebar-section-title--datanexus::before {
    background: #4fc3f7;
  }

  .sidebar-section-title--dw::before {
    background: #ab47bc;
  }

  .sidebar-section-title--etl::before {
    background: #66bb6a;
  }

  .sidebar-section li a {
    font-size: 0.82rem;
    padding: 7px 20px;
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

   
  .sidebar-stats {
    padding: 10px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    margin-top: 4px;
    display: none;
    flex-direction: column;
    gap: 6px;
  }

  .sidebar-stat-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 2px;
    height: 28px;
  }

  .stat-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .stat-dot--pv {
    background: #667eea;
  }

  .stat-dot--uv {
    background: #f5576c;
  }

  .sidebar-stat-value {
    font-weight: 600;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    font-variant-numeric: tabular-nums;
  }

  .sidebar-stat-label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.3);
  }

   
  .sidebar-dashboard-links {
    padding: 8px 20px;
    display: none;
    flex-direction: column;
    gap: 5px;
  }

  .sidebar-dashboard-links.visible {
    display: flex;
  }

  .sidebar-stats.visible {
    display: flex;
  }

  .sidebar-dashboard-links a {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    font-size: 0.7rem;
    white-space: nowrap;
    color: rgba(255, 255, 255, 0.5);
    text-decoration: none;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    transition: all 0.2s;
  }

  .sidebar-dashboard-links a:hover {
    color: #fff;
    background: var(--sidebar-hover);
    border-color: var(--sidebar-accent);
  }

   
  .site-wrapper {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
  }

   
  .sidebar-toggle {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 101;
    background: var(--sidebar-active-bg);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    cursor: pointer;
    box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }

  .sidebar-toggle:hover {
    transform: scale(1.08);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99;
    backdrop-filter: blur(2px);
  }

   
  @media (max-width: 860px) {
    .sidebar {
      transform: translateX(-100%);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-toggle {
      display: flex;
    }

    .sidebar-overlay.open {
      display: block;
    }

    .site-wrapper {
      margin-left: 0;
    }
  }
</style>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q0RS9ZG67P"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-Q0RS9ZG67P');
        }
      </script><meta property="og:url" content="https://biz-agentic-ai.github.io/guides/etl-design/004-scd/">
  <meta property="og:site_name" content="Junho Lee | DataNexus 구축 과정">
  <meta property="og:title" content="4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가">
  <meta property="og:description" content="차원 데이터가 바뀌면 과거를 덮어쓸 것인가, 이력을 남길 것인가. SCD Type 1, 2, 3의 차이를 SQL로 직접 구현하고, dbt snapshot으로 프로덕션 패턴을 만든다.">
  <meta property="og:locale" content="ko">
  <meta property="og:type" content="article">
    <meta property="article:section" content="guides">
    <meta property="article:published_time" content="2026-02-22T13:00:00+09:00">
    <meta property="article:modified_time" content="2026-02-22T13:00:00+09:00">
    <meta property="article:tag" content="Etl">
    <meta property="article:tag" content="Scd">
    <meta property="article:tag" content="Dbt-Snapshot">
      <meta property="og:see_also" content="https://biz-agentic-ai.github.io/guides/etl-design/003-silver-layer/">
      <meta property="og:see_also" content="https://biz-agentic-ai.github.io/guides/etl-design/002-bronze-layer/">
      <meta property="og:see_also" content="https://biz-agentic-ai.github.io/guides/etl-design/001-medallion-architecture/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가">
<meta name="twitter:description" content="차원 데이터가 바뀌면 과거를 덮어쓸 것인가, 이력을 남길 것인가. SCD Type 1, 2, 3의 차이를 SQL로 직접 구현하고, dbt snapshot으로 프로덕션 패턴을 만든다.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "기술 가이드",
      "item": "https://biz-agentic-ai.github.io/guides/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ETL 설계",
      "item": "https://biz-agentic-ai.github.io/guides/etl-design/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가",
      "item": "https://biz-agentic-ai.github.io/guides/etl-design/004-scd/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가",
  "name": "4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가",
  "description": "차원 데이터가 바뀌면 과거를 덮어쓸 것인가, 이력을 남길 것인가. SCD Type 1, 2, 3의 차이를 SQL로 직접 구현하고, dbt snapshot으로 프로덕션 패턴을 만든다.",
  "keywords": [
    "etl", "scd", "dbt-snapshot"
  ],
  "articleBody": "\rGoogle Colab에서 실습하기\r고객이 이사했다. 과거 주문의 배송지는? jaffle_shop의 고객 한 명이 서울에서 부산으로 이사했다고 하자. customers 테이블에서 city를 ‘부산’으로 UPDATE한다. 이제 과거 주문을 조회하면 배송지가 전부 “부산\"으로 나온다. 실제로는 서울로 배송된 주문인데.\nDW 모델링 2편에서 다뤘던 “시점 데이터” 문제와 같은 구조다. OLTP는 현재 상태만 관리한다. DW는 “그 시점에 어떤 값이었는가\"를 알아야 한다. 담당자가 바뀌면 과거 실적은 누구 기준으로 볼 것인가. 고객 등급이 바뀌면 과거 주문은 어느 등급으로 집계할 것인가. 같은 문제다.\nKimball이 이걸 체계적으로 정리했다. SCD(Slowly Changing Dimension) -천천히 변하는 차원. 차원 속성이 바뀌면 어떻게 할 것인가를 유형별로 나눈 체계다. “천천히\"라는 이름은 팩트 데이터(주문, 로그)처럼 끊임없이 쌓이는 것과 대비해서 붙었다. 고객 주소, 상품 카테고리, 사원 소속 부서. 자주 바뀌지 않지만, 바뀌기는 한다.\nSCD Type 1 - 덮어쓴다 가장 단순한 방법이다. 현재 값으로 UPDATE하고 끝낸다. 과거 이력은 사라진다.\n-- Type 1: 현재 값으로 덮어쓴다 UPDATE dim_customers SET city = '부산' WHERE customer_id = 1; 실행하고 나면 해당 고객의 과거 주문을 조인하든 현재 주문을 조인하든 전부 “부산\"으로 나온다. 서울에 살던 시절의 정보는 없다.\nType 1이 적합한 경우가 있다. 오타 수정이 대표적이다. “서울특별시\"를 “서울시\"로 바꾸는 건 이력을 남길 이유가 없다. 코드 테이블의 설명 문구 변경, 고객 이름의 오타 교정. 과거를 알 필요가 없는 속성에 쓴다.\nSCD Type 2 - 이력을 쌓는다 과거 값을 보존해야 하면 Type 2를 쓴다. 기존 행을 닫고, 새 행을 추가한다.\n테이블에 세 개의 컬럼을 추가한다.\nvalid_from -이 행이 유효하기 시작한 시점 valid_to -이 행이 유효하지 않게 된 시점 (현재 행은 9999-12-31) is_current -현재 유효한 행인지 여부 -- 초기 상태: customer_id = 1, 서울 -- dim_customers_sk | customer_id | city | valid_from | valid_to | is_current -- 1001 | 1 | 서울 | 2025-01-01 | 9999-12-31 | true 고객이 부산으로 이사하면 두 단계를 실행한다.\n-- 1단계: 기존 행을 닫는다 UPDATE dim_customers SET valid_to = '2026-02-15', is_current = false WHERE customer_id = 1 AND is_current = true; -- 2단계: 새 행을 추가한다 INSERT INTO dim_customers (dim_customers_sk, customer_id, city, valid_from, valid_to, is_current) VALUES (1002, 1, '부산', '2026-02-15', '9999-12-31', true); 이제 한 customer_id에 행이 두 개다.\n-- dim_customers_sk | customer_id | city | valid_from | valid_to | is_current -- 1001 | 1 | 서울 | 2025-01-01 | 2026-02-15 | false -- 1002 | 1 | 부산 | 2026-02-15 | 9999-12-31 | true 여기서 dim_customers_sk 가 서로게이트 키(surrogate key)다. 한 고객에 여러 행이 생기니까 customer_id만으로는 행을 고유하게 식별할 수 없다. 별도 대리 키가 필요한 이유다. 설계 상세는 Gold 편에서 다룬다.\n시점 조회는 이렇게 한다.\n-- 주문 시점의 고객 주소를 조인 SELECT o.order_id, o.order_date, c.city AS city_at_order_time FROM fct_orders o JOIN dim_customers c ON o.customer_id = c.customer_id AND o.order_date BETWEEN c.valid_from AND c.valid_to; 2025년 6월 주문은 “서울”, 2026년 3월 주문은 “부산”. 각 주문 시점의 실제 값이 나온다.\nDW 모델링 1편에서 “SCD Type 2 스토리지 부담이 작아졌다\"고 언급했다. 클라우드 Columnar Storage에서는 행이 늘어나는 비용이 온프레미스 대비 훨씬 작다. Type 2를 더 적극적으로 쓸 수 있는 환경이다.\nSCD Type 3 -이전 값을 컬럼으로 남긴다 이력 깊이가 1단계면 충분할 때 쓴다. 별도 컬럼에 직전 값을 저장한다.\n-- Type 3: 이전 값을 컬럼으로 -- customer_id | city | previous_city -- 1 | 부산 | 서울 구현은 단순하다.\nUPDATE dim_customers SET previous_city = city, city = '부산' WHERE customer_id = 1; 행 수가 늘어나지 않는다. 대신 두 단계 전 값은 없다. 서울 → 부산 → 대전으로 바뀌면 “서울\"은 사라진다.\n적합한 사례가 있다. 조직 개편 전후 비교. “이 사원이 이번 개편 전에는 어느 부서였는가\"만 알면 되는 경우. 직전 값 하나면 충분하고, 전체 이력은 필요 없다.\n어떤 Type을 고를 것인가 기준 Type 1 Type 2 Type 3 이력 보존 없음 전체 직전 1단계 구현 복잡도 낮음 높음 중간 스토리지 변동 없음 행이 계속 늘어남 컬럼 추가 시점 분석 불가 가능 제한적 적합 속성 오타, 코드 설명 주소, 등급, 소속 조직 개편 전후 실무 판단 기준은 간단하다. “과거 시점의 값으로 분석해야 하는가?” 그렇다면 Type 2. 아니라면 Type 1. Type 3은 직전 값만 필요한 특수한 경우에 한정된다.\n하나의 테이블 안에서 컬럼별로 Type을 혼합할 수 있다. city는 Type 2로 이력을 쌓고, phone은 Type 1로 덮어쓴다. 전화번호의 과거 이력으로 분석할 일이 없으니까.\n실습 데이터 준비 jaffle_shop의 raw_customers에는 주소 컬럼이 없다. SCD를 시연하려면 임의의 데이터를 생성해야 한다.\nimport duckdb conn = duckdb.connect('warehouse.duckdb') # SCD 시연용 고객 데이터: city, membership_grade, updated_at 추가 conn.execute(\"\"\" CREATE SCHEMA IF NOT EXISTS bronze; CREATE OR REPLACE TABLE bronze.customers_v2 AS SELECT id AS customer_id, first_name, last_name, CASE WHEN id % 3 = 0 THEN '서울' WHEN id % 3 = 1 THEN '부산' ELSE '대전' END AS city, CASE WHEN id % 4 = 0 THEN 'Gold' WHEN id % 4 = 1 THEN 'Silver' WHEN id % 4 = 2 THEN 'Bronze' ELSE 'Standard' END AS membership_grade, TIMESTAMP '2025-01-15 09:00:00' AS updated_at FROM read_csv_auto( 'https://raw.githubusercontent.com/dbt-labs/jaffle_shop/main/seeds/raw_customers.csv' ); \"\"\") conn.execute(\"SELECT * FROM bronze.customers_v2 LIMIT 5\").fetchdf() 변경 시뮬레이션 데이터도 만든다. 고객 몇 명이 이사하고, 등급이 올라간 상황을 시뮬레이션한다.\n# 변경분 데이터: 일부 고객이 이사했다 conn.execute(\"\"\" CREATE OR REPLACE TABLE bronze.customers_v2_updated AS SELECT customer_id, first_name, last_name, CASE WHEN customer_id IN (1, 3, 5) THEN '제주' ELSE city END AS city, CASE WHEN customer_id IN (2, 4) THEN 'Gold' ELSE membership_grade END AS membership_grade, CASE WHEN customer_id IN (1, 2, 3, 4, 5) THEN TIMESTAMP '2026-02-20 14:00:00' ELSE updated_at END AS updated_at FROM bronze.customers_v2; \"\"\") # 변경된 고객 확인 conn.execute(\"\"\" SELECT a.customer_id, a.city AS before_city, b.city AS after_city, a.membership_grade AS before_grade, b.membership_grade AS after_grade FROM bronze.customers_v2 a JOIN bronze.customers_v2_updated b ON a.customer_id = b.customer_id WHERE a.city != b.city OR a.membership_grade != b.membership_grade \"\"\").fetchdf() dbt snapshot으로 SCD Type 2를 자동화한다 snapshot이란 위에서 Type 2를 SQL로 직접 구현했다. 기존 행을 닫고, 새 행을 넣고, valid_from/valid_to를 관리하고. 테이블이 하나일 때는 할 만하다. 차원 테이블이 10개, 20개로 늘어나면 이 로직을 매번 직접 쓰는 건 현실적이지 않다.\ndbt snapshot이 이걸 대신 해준다. snapshot 파일 하나를 정의하면 dbt가 소스 데이터의 변경을 감지하고, valid_from/valid_to 행을 알아서 관리한다.\nsnapshot 파일 작성 import os os.makedirs('jaffle_shop/snapshots', exist_ok=True) %%writefile jaffle_shop/snapshots/snap_customers.sql {% snapshot snap_customers %} {{ config( target_schema='snapshots', unique_key='customer_id', strategy='timestamp', updated_at='updated_at' ) }} select * from bronze.customers_v2 {% endsnapshot %} strategy='timestamp' -updated_at 컬럼을 기준으로 변경 여부를 판단한다. updated_at이 이전 스냅샷 시점보다 새로우면 변경된 것으로 본다.\nunique_key='customer_id' -어떤 행이 같은 행인지 식별하는 키다. 이 키 기준으로 이전 값과 현재 값을 비교한다.\nsnapshot 실행 from dbt.cli.main import dbtRunner # Colab의 ! 쉘 명령은 별도 프로세스를 띄운다. # DuckDB는 프로세스 간 동시 쓰기를 막는 파일 락을 건다. # dbtRunner로 같은 프로세스 안에서 실행하면 락 충돌이 없다. result = dbtRunner().invoke(['snapshot', '--project-dir', 'jaffle_shop', '--profiles-dir', 'jaffle_shop']) 첫 실행이다. 모든 행이 신규이므로 그대로 들어간다. dbt가 자동으로 dbt_valid_from, dbt_valid_to 컬럼을 추가한다.\nconn.execute(\"SELECT * FROM snapshots.snap_customers LIMIT 5\").fetchdf() dbt_valid_to가 전부 NULL이다. 현재 유효한 행이라는 뜻이다. dbt snapshot은 9999-12-31 대신 NULL을 쓴다.\n이제 변경 데이터를 투입하고 다시 실행한다.\n# 소스 테이블을 변경분으로 교체 conn.execute(\"\"\" CREATE OR REPLACE TABLE bronze.customers_v2 AS SELECT * FROM bronze.customers_v2_updated; \"\"\") conn.close() # snapshot 재실행 result = dbtRunner().invoke(['snapshot', '--project-dir', 'jaffle_shop', '--profiles-dir', 'jaffle_shop']) conn = duckdb.connect('warehouse.duckdb') # 이력이 생성된 고객 확인 conn.execute(\"\"\" SELECT customer_id, city, membership_grade, dbt_valid_from, dbt_valid_to FROM snapshots.snap_customers WHERE customer_id IN (1, 2, 3) ORDER BY customer_id, dbt_valid_from \"\"\").fetchdf() customer_id = 1인 고객에 행이 두 개 생겼다. 첫 번째 행의 dbt_valid_to가 채워졌고, 두 번째 행이 현재 유효한 행이다. SQL 한 줄 안 쓰고 Type 2가 구현됐다.\ncheck 전략 updated_at 컬럼이 없는 소스도 있다. 2편에서 언급했듯, 데이터를 UPDATE하면서 updated_at을 안 바꾸는 시스템이 의외로 많다.\n이런 경우 check 전략을 쓴다. 지정한 컬럼의 값이 바뀌었는지 직접 비교한다.\n%%writefile jaffle_shop/snapshots/snap_customers_check.sql {% snapshot snap_customers_check %} {{ config( target_schema='snapshots', unique_key='customer_id', strategy='check', check_cols=['city', 'membership_grade'] ) }} select customer_id, first_name, last_name, city, membership_grade from bronze.customers_v2 {% endsnapshot %} check_cols=['city', 'membership_grade'] -이 두 컬럼의 값이 이전과 다르면 변경으로 판단한다. updated_at이 필요 없다. 대신 매번 전체 행을 비교하므로 데이터가 크면 timestamp 전략보다 느리다.\nsnapshot을 Silver/Gold와 연결한다 snapshot은 Bronze도 Silver도 아닌 별도 스키마(snapshots)에 저장된다. 메달리온 아키텍처에서 이 위치를 정리하면 이렇다.\n소스 → [Bronze] → [Silver] → [Gold] ↑ Bronze → [Snapshot] ──┘ 1편에서 정의한 레이어 구조에 snapshot이 추가된 형태다. snapshot은 Bronze 데이터를 직접 바라보고, Silver나 Gold 모델이 snapshot 결과를 참조한다.\nSilver 모델에서 snapshot을 참조하는 구조는 이렇다.\n%%writefile jaffle_shop/models/staging/stg_customers_hist.sql with source as ( select * from {{ ref('snap_customers') }} ), cleaned as ( select customer_id, first_name, last_name, city, membership_grade, dbt_valid_from AS valid_from, coalesce(dbt_valid_to, '9999-12-31'::timestamp) AS valid_to, dbt_valid_to IS NULL AS is_current from source ) select * from cleaned dbt의 dbt_valid_from/dbt_valid_to를 valid_from/valid_to로 이름을 바꾸고, NULL을 9999-12-31로 변환했다. Gold에서 BETWEEN 조인을 걸 때 편하다.\nGold 팩트 테이블에서 시점 조인하면 이렇게 된다.\n-- Gold: 주문 시점의 고객 정보로 조인 select o.order_id, o.order_date, c.city AS city_at_order, c.membership_grade AS grade_at_order from stg_orders o join stg_customers_hist c on o.customer_id = c.customer_id and o.order_date \u003e= c.valid_from and o.order_date \u003c c.valid_to SCD 적용 패턴 정리 패턴 적용 대상 구현 방법 Type 1 (덮어쓰기) 오타, 코드 설명, 전화번호 단순 UPDATE Type 2 (이력 추가) 주소, 등급, 소속 부서 dbt snapshot (timestamp / check) Type 3 (이전 값 보존) 조직 개편 전후 비교 previous_ 컬럼 추가 혼합 하나의 테이블 내 컬럼별 구분 Type 1 + Type 2 병행 실무에서는 Type 2가 압도적이다. dbt snapshot이 알아서 처리해주니까 구현 부담도 크지 않다. Type 1은 이력이 필요 없는 속성에 한해서, Type 3은 직전 값만 필요한 드문 경우에 쓴다.\n실무 참고: Airflow에서 dbt snapshot 실행 3편에서 Airflow DAG로 dbt run → dbt test 순서를 잡았다. snapshot이 추가되면 순서가 바뀐다.\nfrom airflow import DAG from airflow.operators.bash import BashOperator from datetime import datetime with DAG( dag_id='medallion_with_snapshot', schedule='0 6 * * *', start_date=datetime(2026, 1, 1), catchup=False, ) as dag: # 1. snapshot 먼저 실행 -Bronze의 변경 이력을 캡처 run_snapshot = BashOperator( task_id='dbt_snapshot', bash_command='cd /opt/dbt/jaffle_shop \u0026\u0026 dbt snapshot', ) # 2. Silver 변환 -snapshot 결과를 참조하는 모델이 있으니까 run_staging = BashOperator( task_id='dbt_run_staging', bash_command='cd /opt/dbt/jaffle_shop \u0026\u0026 dbt run --select staging', ) # 3. Gold 변환 run_marts = BashOperator( task_id='dbt_run_marts', bash_command='cd /opt/dbt/jaffle_shop \u0026\u0026 dbt run --select marts', ) run_snapshot \u003e\u003e run_staging \u003e\u003e run_marts 핵심은 run_snapshot \u003e\u003e run_staging 순서다. Silver 모델 중 stg_customers_hist가 snap_customers를 참조한다. snapshot이 먼저 실행되어야 Silver가 최신 이력을 반영할 수 있다. snapshot을 Silver 뒤에 돌리면 이번 배치에서 감지된 변경이 다음 배치에서야 Silver에 반영된다. 하루 늦는다.\n다음 글에서는 Gold 레이어를 다룬다. Silver에서 정제한 데이터와 snapshot 이력을 합쳐서 팩트·차원 테이블을 구성하는 과정이다. dbt marts 디렉토리가 본격적으로 등장한다.\nGoogle Colab에서 실습하기\r",
  "wordCount" : "1625",
  "inLanguage": "en",
  "datePublished": "2026-02-22T13:00:00+09:00",
  "dateModified": "2026-02-22T13:00:00+09:00",
  "author":{
    "@type": "Person",
    "name": "Junho Lee"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://biz-agentic-ai.github.io/guides/etl-design/004-scd/"
  },
  "publisher": {
    "@type": "Person",
    "name": "Junho Lee | DataNexus 구축 과정",
    "logo": {
      "@type": "ImageObject",
      "url": "https://biz-agentic-ai.github.io/favicon.svg"
    }
  }
}
</script>
</head>

<body class="" id="top"><script data-goatcounter="https://biz-agentic-ai.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<aside class="sidebar" id="sidebar">
  <div class="sidebar-inner"><div class="sidebar-header">
      <a href="https://biz-agentic-ai.github.io/" class="sidebar-logo">
        <img src="/images/DataNexus_Logo.jpg" alt="DataNexus" class="sidebar-logo-img">
        DataNexus
      </a>
      <span class="sidebar-subtitle">구축 과정</span>
    </div>
    <div class="sidebar-section">
      <h3 class="sidebar-section-title sidebar-section-title--datanexus">DataNexus Series</h3>
      <ul>
        <li>
          <a href="https://biz-agentic-ai.github.io/posts/datanexus/004-skos-compatibility-layer/" title="4. SKOS 호환 레이어를 왜 넣었는가" >
            4. SKOS 호환 레이어를 왜 넣었는가
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/posts/datanexus/003-datahub-glossary-as-ontology/" title="3. DataHub Glossary를 온톨로지로 쓸 수 있을까" >
            3. DataHub Glossary를 온톨로지로 쓸 수 있을까
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/posts/datanexus/002-architecture-decisions/" title="2. 4개의 오픈소스를 이 조합으로 결정하기까지" >
            2. 4개의 오픈소스를 이 조합으로 결정하기까지
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/posts/datanexus/001-why-datanexus/" title="1. 왜 DataNexus를 만드는가" >
            1. 왜 DataNexus를 만드는가
          </a>
        </li>
      </ul>
    </div>
    <div class="sidebar-section">
      <h3 class="sidebar-section-title sidebar-section-title--dw">DW 모델링 Guide</h3>
      <ul>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/dw-modeling/004-super-sub-type/" title="4. 수퍼-서브 타입 - 고객이 개인이면서 법인일 수 있는가" >
            4. 수퍼-서브 타입 - 고객이 개인이면서 법인일 수 있는가
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/dw-modeling/003-erd-notation/" title="3. ERD 표기법 - 같은 그림, 다른 해석" >
            3. ERD 표기법 - 같은 그림, 다른 해석
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/dw-modeling/002-oltp-vs-dw-model/" title="2. OLTP vs DW 모델 - 목적이 다르면 설계도 다르다" >
            2. OLTP vs DW 모델 - 목적이 다르면 설계도 다르다
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/dw-modeling/001-cloud-era-dw-modeling/" title="1. 클라우드 DW에서 Kimball은 여전히 유효한가" >
            1. 클라우드 DW에서 Kimball은 여전히 유효한가
          </a>
        </li>
      </ul>
    </div>
    <div class="sidebar-section">
      <h3 class="sidebar-section-title sidebar-section-title--etl">ETL 설계 Guide</h3>
      <ul>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/etl-design/004-scd/" title="4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가"  class="active" >
            4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/etl-design/003-silver-layer/" title="3. Silver 레이어 - Bronze를 분석 가능한 상태로 올린다" >
            3. Silver 레이어 - Bronze를 분석 가능한 상태로 올린다
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/etl-design/002-bronze-layer/" title="2. Bronze 레이어 - 원본을 있는 그대로 쌓는다" >
            2. Bronze 레이어 - 원본을 있는 그대로 쌓는다
          </a>
        </li>
        <li>
          <a href="https://biz-agentic-ai.github.io/guides/etl-design/001-medallion-architecture/" title="1. 메달리온 아키텍처 - 데이터를 세 겹으로 쌓는 이유" >
            1. 메달리온 아키텍처 - 데이터를 세 겹으로 쌓는 이유
          </a>
        </li>
      </ul>
    </div><div class="sidebar-stats" id="sidebar-stats">
      <div class="sidebar-stat-pill" id="gc-container-pv" style="display:none;">
        <span class="stat-dot stat-dot--pv"></span>
        <span class="sidebar-stat-value" id="gc-value-pv">-</span>
        <span class="sidebar-stat-label">views</span>
      </div>
      <div class="sidebar-stat-pill" id="gc-container-uv" style="display:none;">
        <span class="stat-dot stat-dot--uv"></span>
        <span class="sidebar-stat-value" id="gc-value-uv">-</span>
        <span class="sidebar-stat-label">visitors</span>
      </div>
    </div>
    <script>
      (function () {
        var p = encodeURIComponent(location.pathname);
        fetch('https://biz-agentic-ai.goatcounter.com/counter/' + p + '.json')
          .then(function (r) { return r.json(); })
          .then(function (d) {
            if (d.count) {
              document.getElementById('gc-value-pv').textContent = d.count;
              document.getElementById('gc-container-pv').style.display = '';
            }
            if (d.count_unique) {
              document.getElementById('gc-value-uv').textContent = d.count_unique;
              document.getElementById('gc-container-uv').style.display = '';
            }
          })
          .catch(function () { });
      })();
    </script><div class="sidebar-dashboard-links" id="dashboard-links">
      <a href="https://biz-agentic-ai.goatcounter.com/" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        GoatCounter
      </a>
      <a href="https://analytics.google.com/analytics/web/" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
          <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </svg>
        GA4 Dashboard
      </a>
    </div>
    <script>
      (function () {
        var el = document.getElementById('dashboard-links');
        var stats = document.getElementById('sidebar-stats');
        if (localStorage.getItem('dn-admin')) {
          el.classList.add('visible');
          stats.classList.add('visible');
        }
        document.querySelector('.sidebar-logo').addEventListener('dblclick', function () {
          var on = localStorage.getItem('dn-admin');
          if (on) {
            localStorage.removeItem('dn-admin');
            el.classList.remove('visible');
            stats.classList.remove('visible');
          } else {
            localStorage.setItem('dn-admin', '1');
            el.classList.add('visible');
            stats.classList.add('visible');
          }
        });
      })();
    </script>

  </div>
</aside><button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</button>
<div class="sidebar-overlay" id="sidebar-overlay"></div><div class="site-wrapper">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://biz-agentic-ai.github.io/" accesskey="h" title="Junho Lee | DataNexus 구축 과정 (Alt + H)">Junho Lee | DataNexus 구축 과정</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://biz-agentic-ai.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://biz-agentic-ai.github.io/guides/" title="Guides">
                    <span>Guides</span>
                </a>
            </li>
            <li>
                <a href="https://biz-agentic-ai.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://biz-agentic-ai.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://biz-agentic-ai.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://biz-agentic-ai.github.io/">홈</a>&nbsp;»&nbsp;<a href="https://biz-agentic-ai.github.io/guides/">기술 가이드</a>&nbsp;»&nbsp;<a href="https://biz-agentic-ai.github.io/guides/etl-design/">ETL 설계</a></div>
    <h1 class="post-title entry-hint-parent">
      4. SCD - 고객 주소가 바뀌면 과거 주문은 어디로 배송된 걸로 남는가
    </h1>
    <div class="post-meta"><span title='2026-02-22 13:00:00 +0900 KST'>February 22, 2026</span>&nbsp;·&nbsp;8 분&nbsp;·&nbsp;Junho Lee

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">목차</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%ea%b3%a0%ea%b0%9d%ec%9d%b4-%ec%9d%b4%ec%82%ac%ed%96%88%eb%8b%a4-%ea%b3%bc%ea%b1%b0-%ec%a3%bc%eb%ac%b8%ec%9d%98-%eb%b0%b0%ec%86%a1%ec%a7%80%eb%8a%94" aria-label="고객이 이사했다. 과거 주문의 배송지는?">고객이 이사했다. 과거 주문의 배송지는?</a></li>
                <li>
                    <a href="#scd-type-1---%eb%8d%ae%ec%96%b4%ec%93%b4%eb%8b%a4" aria-label="SCD Type 1 - 덮어쓴다">SCD Type 1 - 덮어쓴다</a></li>
                <li>
                    <a href="#scd-type-2---%ec%9d%b4%eb%a0%a5%ec%9d%84-%ec%8c%93%eb%8a%94%eb%8b%a4" aria-label="SCD Type 2 - 이력을 쌓는다">SCD Type 2 - 이력을 쌓는다</a></li>
                <li>
                    <a href="#scd-type-3--%ec%9d%b4%ec%a0%84-%ea%b0%92%ec%9d%84-%ec%bb%ac%eb%9f%bc%ec%9c%bc%eb%a1%9c-%eb%82%a8%ea%b8%b4%eb%8b%a4" aria-label="SCD Type 3 -이전 값을 컬럼으로 남긴다">SCD Type 3 -이전 값을 컬럼으로 남긴다</a></li>
                <li>
                    <a href="#%ec%96%b4%eb%96%a4-type%ec%9d%84-%ea%b3%a0%eb%a5%bc-%ea%b2%83%ec%9d%b8%ea%b0%80" aria-label="어떤 Type을 고를 것인가">어떤 Type을 고를 것인가</a></li>
                <li>
                    <a href="#%ec%8b%a4%ec%8a%b5-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%a4%80%eb%b9%84" aria-label="실습 데이터 준비">실습 데이터 준비</a></li>
                <li>
                    <a href="#dbt-snapshot%ec%9c%bc%eb%a1%9c-scd-type-2%eb%a5%bc-%ec%9e%90%eb%8f%99%ed%99%94%ed%95%9c%eb%8b%a4" aria-label="dbt snapshot으로 SCD Type 2를 자동화한다">dbt snapshot으로 SCD Type 2를 자동화한다</a><ul>
                        
                <li>
                    <a href="#snapshot%ec%9d%b4%eb%9e%80" aria-label="snapshot이란">snapshot이란</a></li>
                <li>
                    <a href="#snapshot-%ed%8c%8c%ec%9d%bc-%ec%9e%91%ec%84%b1" aria-label="snapshot 파일 작성">snapshot 파일 작성</a></li>
                <li>
                    <a href="#snapshot-%ec%8b%a4%ed%96%89" aria-label="snapshot 실행">snapshot 실행</a></li>
                <li>
                    <a href="#check-%ec%a0%84%eb%9e%b5" aria-label="check 전략">check 전략</a></li></ul>
                </li>
                <li>
                    <a href="#snapshot%ec%9d%84-silvergold%ec%99%80-%ec%97%b0%ea%b2%b0%ed%95%9c%eb%8b%a4" aria-label="snapshot을 Silver/Gold와 연결한다">snapshot을 Silver/Gold와 연결한다</a></li>
                <li>
                    <a href="#scd-%ec%a0%81%ec%9a%a9-%ed%8c%a8%ed%84%b4-%ec%a0%95%eb%a6%ac" aria-label="SCD 적용 패턴 정리">SCD 적용 패턴 정리</a></li>
                <li>
                    <a href="#%ec%8b%a4%eb%ac%b4-%ec%b0%b8%ea%b3%a0-airflow%ec%97%90%ec%84%9c-dbt-snapshot-%ec%8b%a4%ed%96%89" aria-label="실무 참고: Airflow에서 dbt snapshot 실행">실무 참고: Airflow에서 dbt snapshot 실행</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><div style="margin: 1.2em 0;">
  <a href="https://colab.research.google.com/github/biz-agentic-ai/biz-agentic-ai.github.io/blob/main/notebooks/etl-004-scd.ipynb" target="_blank" rel="noopener noreferrer"
     style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            background: linear-gradient(135deg, #f9ab00 0%, #f57c00 100%);
            color: #fff; text-decoration: none; border-radius: 8px;
            font-weight: 600; font-size: 0.95em;
            box-shadow: 0 2px 8px rgba(245,124,0,0.25);
            transition: all 0.2s ease;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="white"/>
    </svg>
    Google Colab에서 실습하기
  </a>
</div>

<h2 id="고객이-이사했다-과거-주문의-배송지는">고객이 이사했다. 과거 주문의 배송지는?<a hidden class="anchor" aria-hidden="true" href="#고객이-이사했다-과거-주문의-배송지는">#</a></h2>
<p>jaffle_shop의 고객 한 명이 서울에서 부산으로 이사했다고 하자. <code>customers</code> 테이블에서 <code>city</code>를 &lsquo;부산&rsquo;으로 UPDATE한다. 이제 과거 주문을 조회하면 배송지가 전부 &ldquo;부산&quot;으로 나온다. 실제로는 서울로 배송된 주문인데.</p>
<p><a href="https://biz-agentic-ai.github.io/guides/dw-modeling/002-oltp-vs-dw-model/">DW 모델링 2편</a>에서 다뤘던 &ldquo;시점 데이터&rdquo; 문제와 같은 구조다. OLTP는 현재 상태만 관리한다. DW는 &ldquo;그 시점에 어떤 값이었는가&quot;를 알아야 한다. 담당자가 바뀌면 과거 실적은 누구 기준으로 볼 것인가. 고객 등급이 바뀌면 과거 주문은 어느 등급으로 집계할 것인가. 같은 문제다.</p>
<p>Kimball이 이걸 체계적으로 정리했다. <strong>SCD(Slowly Changing Dimension)</strong> -천천히 변하는 차원. 차원 속성이 바뀌면 어떻게 할 것인가를 유형별로 나눈 체계다. &ldquo;천천히&quot;라는 이름은 팩트 데이터(주문, 로그)처럼 끊임없이 쌓이는 것과 대비해서 붙었다. 고객 주소, 상품 카테고리, 사원 소속 부서. 자주 바뀌지 않지만, 바뀌기는 한다.</p>
<h2 id="scd-type-1---덮어쓴다">SCD Type 1 - 덮어쓴다<a hidden class="anchor" aria-hidden="true" href="#scd-type-1---덮어쓴다">#</a></h2>
<p>가장 단순한 방법이다. 현재 값으로 UPDATE하고 끝낸다. 과거 이력은 사라진다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- Type 1: 현재 값으로 덮어쓴다
</span></span></span><span style="display:flex;"><span><span style="color:#bb9af7">UPDATE</span> dim_customers
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">SET</span> city <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#9ece6a">&#39;부산&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">WHERE</span> customer_id <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#e0af68">1</span>;
</span></span></code></pre></div><p>실행하고 나면 해당 고객의 과거 주문을 조인하든 현재 주문을 조인하든 전부 &ldquo;부산&quot;으로 나온다. 서울에 살던 시절의 정보는 없다.</p>
<p>Type 1이 적합한 경우가 있다. 오타 수정이 대표적이다. &ldquo;서울특별시&quot;를 &ldquo;서울시&quot;로 바꾸는 건 이력을 남길 이유가 없다. 코드 테이블의 설명 문구 변경, 고객 이름의 오타 교정. 과거를 알 필요가 없는 속성에 쓴다.</p>
<h2 id="scd-type-2---이력을-쌓는다">SCD Type 2 - 이력을 쌓는다<a hidden class="anchor" aria-hidden="true" href="#scd-type-2---이력을-쌓는다">#</a></h2>
<p>과거 값을 보존해야 하면 Type 2를 쓴다. 기존 행을 닫고, 새 행을 추가한다.</p>
<p>테이블에 세 개의 컬럼을 추가한다.</p>
<ul>
<li><code>valid_from</code> -이 행이 유효하기 시작한 시점</li>
<li><code>valid_to</code> -이 행이 유효하지 않게 된 시점 (현재 행은 <code>9999-12-31</code>)</li>
<li><code>is_current</code> -현재 유효한 행인지 여부</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 초기 상태: customer_id = 1, 서울
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- dim_customers_sk | customer_id | city | valid_from | valid_to   | is_current
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 1001             | 1           | 서울 | 2025-01-01 | 9999-12-31 | true
</span></span></span></code></pre></div><p>고객이 부산으로 이사하면 두 단계를 실행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 1단계: 기존 행을 닫는다
</span></span></span><span style="display:flex;"><span><span style="color:#bb9af7">UPDATE</span> dim_customers
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">SET</span> valid_to <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#9ece6a">&#39;2026-02-15&#39;</span>,
</span></span><span style="display:flex;"><span>    is_current <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#bb9af7">false</span>
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">WHERE</span> customer_id <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#e0af68">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#bb9af7">AND</span> is_current <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#bb9af7">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 2단계: 새 행을 추가한다
</span></span></span><span style="display:flex;"><span><span style="color:#bb9af7">INSERT</span> <span style="color:#bb9af7">INTO</span> dim_customers (dim_customers_sk, customer_id, city, valid_from, valid_to, is_current)
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">VALUES</span> (<span style="color:#e0af68">1002</span>, <span style="color:#e0af68">1</span>, <span style="color:#9ece6a">&#39;부산&#39;</span>, <span style="color:#9ece6a">&#39;2026-02-15&#39;</span>, <span style="color:#9ece6a">&#39;9999-12-31&#39;</span>, <span style="color:#bb9af7">true</span>);
</span></span></code></pre></div><p>이제 한 <code>customer_id</code>에 행이 두 개다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- dim_customers_sk | customer_id | city | valid_from | valid_to   | is_current
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 1001             | 1           | 서울 | 2025-01-01 | 2026-02-15 | false
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 1002             | 1           | 부산 | 2026-02-15 | 9999-12-31 | true
</span></span></span></code></pre></div><p>여기서 <code>dim_customers_sk</code> 가 서로게이트 키(surrogate key)다. 한 고객에 여러 행이 생기니까 <code>customer_id</code>만으로는 행을 고유하게 식별할 수 없다. 별도 대리 키가 필요한 이유다. 설계 상세는 Gold 편에서 다룬다.</p>
<p>시점 조회는 이렇게 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 주문 시점의 고객 주소를 조인
</span></span></span><span style="display:flex;"><span><span style="color:#bb9af7">SELECT</span>
</span></span><span style="display:flex;"><span>    o.order_id,
</span></span><span style="display:flex;"><span>    o.order_date,
</span></span><span style="display:flex;"><span>    <span style="color:#bb9af7">c</span>.city <span style="color:#bb9af7">AS</span> city_at_order_time
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">FROM</span> fct_orders o
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">JOIN</span> dim_customers <span style="color:#bb9af7">c</span>
</span></span><span style="display:flex;"><span>  <span style="color:#bb9af7">ON</span> o.customer_id <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#bb9af7">c</span>.customer_id
</span></span><span style="display:flex;"><span> <span style="color:#bb9af7">AND</span> o.order_date <span style="color:#bb9af7">BETWEEN</span> <span style="color:#bb9af7">c</span>.valid_from <span style="color:#bb9af7">AND</span> <span style="color:#bb9af7">c</span>.valid_to;
</span></span></code></pre></div><p>2025년 6월 주문은 &ldquo;서울&rdquo;, 2026년 3월 주문은 &ldquo;부산&rdquo;. 각 주문 시점의 실제 값이 나온다.</p>
<p><a href="https://biz-agentic-ai.github.io/guides/dw-modeling/001-cloud-era-dw-modeling/">DW 모델링 1편</a>에서 &ldquo;SCD Type 2 스토리지 부담이 작아졌다&quot;고 언급했다. 클라우드 Columnar Storage에서는 행이 늘어나는 비용이 온프레미스 대비 훨씬 작다. Type 2를 더 적극적으로 쓸 수 있는 환경이다.</p>
<h2 id="scd-type-3--이전-값을-컬럼으로-남긴다">SCD Type 3 -이전 값을 컬럼으로 남긴다<a hidden class="anchor" aria-hidden="true" href="#scd-type-3--이전-값을-컬럼으로-남긴다">#</a></h2>
<p>이력 깊이가 1단계면 충분할 때 쓴다. 별도 컬럼에 직전 값을 저장한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- Type 3: 이전 값을 컬럼으로
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- customer_id | city     | previous_city
</span></span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- 1           | 부산     | 서울
</span></span></span></code></pre></div><p>구현은 단순하다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#bb9af7">UPDATE</span> dim_customers
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">SET</span> previous_city <span style="color:#9ece6a;font-weight:bold">=</span> city,
</span></span><span style="display:flex;"><span>    city <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#9ece6a">&#39;부산&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">WHERE</span> customer_id <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#e0af68">1</span>;
</span></span></code></pre></div><p>행 수가 늘어나지 않는다. 대신 두 단계 전 값은 없다. 서울 → 부산 → 대전으로 바뀌면 &ldquo;서울&quot;은 사라진다.</p>
<p>적합한 사례가 있다. 조직 개편 전후 비교. &ldquo;이 사원이 이번 개편 전에는 어느 부서였는가&quot;만 알면 되는 경우. 직전 값 하나면 충분하고, 전체 이력은 필요 없다.</p>
<h2 id="어떤-type을-고를-것인가">어떤 Type을 고를 것인가<a hidden class="anchor" aria-hidden="true" href="#어떤-type을-고를-것인가">#</a></h2>
<table>
  <thead>
      <tr>
          <th>기준</th>
          <th>Type 1</th>
          <th>Type 2</th>
          <th>Type 3</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>이력 보존</td>
          <td>없음</td>
          <td>전체</td>
          <td>직전 1단계</td>
      </tr>
      <tr>
          <td>구현 복잡도</td>
          <td>낮음</td>
          <td>높음</td>
          <td>중간</td>
      </tr>
      <tr>
          <td>스토리지</td>
          <td>변동 없음</td>
          <td>행이 계속 늘어남</td>
          <td>컬럼 추가</td>
      </tr>
      <tr>
          <td>시점 분석</td>
          <td>불가</td>
          <td>가능</td>
          <td>제한적</td>
      </tr>
      <tr>
          <td>적합 속성</td>
          <td>오타, 코드 설명</td>
          <td>주소, 등급, 소속</td>
          <td>조직 개편 전후</td>
      </tr>
  </tbody>
</table>
<p>실무 판단 기준은 간단하다. &ldquo;과거 시점의 값으로 분석해야 하는가?&rdquo; 그렇다면 Type 2. 아니라면 Type 1. Type 3은 직전 값만 필요한 특수한 경우에 한정된다.</p>
<p>하나의 테이블 안에서 컬럼별로 Type을 혼합할 수 있다. <code>city</code>는 Type 2로 이력을 쌓고, <code>phone</code>은 Type 1로 덮어쓴다. 전화번호의 과거 이력으로 분석할 일이 없으니까.</p>
<h2 id="실습-데이터-준비">실습 데이터 준비<a hidden class="anchor" aria-hidden="true" href="#실습-데이터-준비">#</a></h2>
<p>jaffle_shop의 <code>raw_customers</code>에는 주소 컬럼이 없다. SCD를 시연하려면 임의의 데이터를 생성해야 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7dcfff">import</span> <span style="color:#e0af68">duckdb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn <span style="color:#9ece6a;font-weight:bold">=</span> duckdb<span style="color:#9ece6a;font-weight:bold">.</span>connect(<span style="color:#9ece6a">&#39;warehouse.duckdb&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># SCD 시연용 고객 데이터: city, membership_grade, updated_at 추가</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">CREATE SCHEMA IF NOT EXISTS bronze;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">CREATE OR REPLACE TABLE bronze.customers_v2 AS
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    id AS customer_id,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    first_name,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    last_name,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    CASE
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN id % 3 = 0 THEN &#39;서울&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN id % 3 = 1 THEN &#39;부산&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        ELSE &#39;대전&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    END AS city,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    CASE
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN id % 4 = 0 THEN &#39;Gold&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN id % 4 = 1 THEN &#39;Silver&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN id % 4 = 2 THEN &#39;Bronze&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        ELSE &#39;Standard&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    END AS membership_grade,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    TIMESTAMP &#39;2025-01-15 09:00:00&#39; AS updated_at
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">FROM read_csv_auto(
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    &#39;https://raw.githubusercontent.com/dbt-labs/jaffle_shop/main/seeds/raw_customers.csv&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">);
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;SELECT * FROM bronze.customers_v2 LIMIT 5&#34;</span>)<span style="color:#9ece6a;font-weight:bold">.</span>fetchdf()
</span></span></code></pre></div><p>변경 시뮬레이션 데이터도 만든다. 고객 몇 명이 이사하고, 등급이 올라간 상황을 시뮬레이션한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># 변경분 데이터: 일부 고객이 이사했다</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">CREATE OR REPLACE TABLE bronze.customers_v2_updated AS
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    customer_id,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    first_name,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    last_name,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    CASE
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN customer_id IN (1, 3, 5) THEN &#39;제주&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        ELSE city
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    END AS city,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    CASE
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN customer_id IN (2, 4) THEN &#39;Gold&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        ELSE membership_grade
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    END AS membership_grade,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    CASE
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        WHEN customer_id IN (1, 2, 3, 4, 5) THEN TIMESTAMP &#39;2026-02-20 14:00:00&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">        ELSE updated_at
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">    END AS updated_at
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">FROM bronze.customers_v2;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># 변경된 고객 확인</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">SELECT a.customer_id, a.city AS before_city, b.city AS after_city,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">       a.membership_grade AS before_grade, b.membership_grade AS after_grade
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">FROM bronze.customers_v2 a
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">JOIN bronze.customers_v2_updated b ON a.customer_id = b.customer_id
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">WHERE a.city != b.city OR a.membership_grade != b.membership_grade
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">&#34;&#34;&#34;</span>)<span style="color:#9ece6a;font-weight:bold">.</span>fetchdf()
</span></span></code></pre></div><h2 id="dbt-snapshot으로-scd-type-2를-자동화한다">dbt snapshot으로 SCD Type 2를 자동화한다<a hidden class="anchor" aria-hidden="true" href="#dbt-snapshot으로-scd-type-2를-자동화한다">#</a></h2>
<h3 id="snapshot이란">snapshot이란<a hidden class="anchor" aria-hidden="true" href="#snapshot이란">#</a></h3>
<p>위에서 Type 2를 SQL로 직접 구현했다. 기존 행을 닫고, 새 행을 넣고, <code>valid_from</code>/<code>valid_to</code>를 관리하고. 테이블이 하나일 때는 할 만하다. 차원 테이블이 10개, 20개로 늘어나면 이 로직을 매번 직접 쓰는 건 현실적이지 않다.</p>
<p>dbt snapshot이 이걸 대신 해준다. snapshot 파일 하나를 정의하면 dbt가 소스 데이터의 변경을 감지하고, <code>valid_from</code>/<code>valid_to</code> 행을 알아서 관리한다.</p>
<h3 id="snapshot-파일-작성">snapshot 파일 작성<a hidden class="anchor" aria-hidden="true" href="#snapshot-파일-작성">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7dcfff">import</span> <span style="color:#e0af68">os</span>
</span></span><span style="display:flex;"><span>os<span style="color:#9ece6a;font-weight:bold">.</span>makedirs(<span style="color:#9ece6a">&#39;jaffle_shop/snapshots&#39;</span>, exist_ok<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#e0af68">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#9ece6a;font-weight:bold">%%</span>writefile jaffle_shop<span style="color:#9ece6a;font-weight:bold">/</span>snapshots<span style="color:#9ece6a;font-weight:bold">/</span>snap_customers<span style="color:#9ece6a;font-weight:bold">.</span>sql
</span></span><span style="display:flex;"><span>{<span style="color:#9ece6a;font-weight:bold">%</span> snapshot snap_customers <span style="color:#9ece6a;font-weight:bold">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{
</span></span><span style="display:flex;"><span>    config(
</span></span><span style="display:flex;"><span>        target_schema<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;snapshots&#39;</span>,
</span></span><span style="display:flex;"><span>        unique_key<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;customer_id&#39;</span>,
</span></span><span style="display:flex;"><span>        strategy<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;timestamp&#39;</span>,
</span></span><span style="display:flex;"><span>        updated_at<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;updated_at&#39;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>select <span style="color:#9ece6a;font-weight:bold">*</span> <span style="color:#7dcfff">from</span> <span style="color:#e0af68">bronze.customers_v2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#9ece6a;font-weight:bold">%</span> endsnapshot <span style="color:#9ece6a;font-weight:bold">%</span>}
</span></span></code></pre></div><p><code>strategy='timestamp'</code> -<code>updated_at</code> 컬럼을 기준으로 변경 여부를 판단한다. <code>updated_at</code>이 이전 스냅샷 시점보다 새로우면 변경된 것으로 본다.</p>
<p><code>unique_key='customer_id'</code> -어떤 행이 같은 행인지 식별하는 키다. 이 키 기준으로 이전 값과 현재 값을 비교한다.</p>
<h3 id="snapshot-실행">snapshot 실행<a hidden class="anchor" aria-hidden="true" href="#snapshot-실행">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7dcfff">from</span> <span style="color:#e0af68">dbt.cli.main</span> <span style="color:#7dcfff">import</span> dbtRunner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># Colab의 ! 쉘 명령은 별도 프로세스를 띄운다.</span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># DuckDB는 프로세스 간 동시 쓰기를 막는 파일 락을 건다.</span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># dbtRunner로 같은 프로세스 안에서 실행하면 락 충돌이 없다.</span>
</span></span><span style="display:flex;"><span>result <span style="color:#9ece6a;font-weight:bold">=</span> dbtRunner()<span style="color:#9ece6a;font-weight:bold">.</span>invoke([<span style="color:#9ece6a">&#39;snapshot&#39;</span>, <span style="color:#9ece6a">&#39;--project-dir&#39;</span>, <span style="color:#9ece6a">&#39;jaffle_shop&#39;</span>, <span style="color:#9ece6a">&#39;--profiles-dir&#39;</span>, <span style="color:#9ece6a">&#39;jaffle_shop&#39;</span>])
</span></span></code></pre></div><p>첫 실행이다. 모든 행이 신규이므로 그대로 들어간다. dbt가 자동으로 <code>dbt_valid_from</code>, <code>dbt_valid_to</code> 컬럼을 추가한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;SELECT * FROM snapshots.snap_customers LIMIT 5&#34;</span>)<span style="color:#9ece6a;font-weight:bold">.</span>fetchdf()
</span></span></code></pre></div><p><code>dbt_valid_to</code>가 전부 NULL이다. 현재 유효한 행이라는 뜻이다. dbt snapshot은 <code>9999-12-31</code> 대신 NULL을 쓴다.</p>
<p>이제 변경 데이터를 투입하고 다시 실행한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># 소스 테이블을 변경분으로 교체</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">CREATE OR REPLACE TABLE bronze.customers_v2 AS
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">SELECT * FROM bronze.customers_v2_updated;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>close()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># snapshot 재실행</span>
</span></span><span style="display:flex;"><span>result <span style="color:#9ece6a;font-weight:bold">=</span> dbtRunner()<span style="color:#9ece6a;font-weight:bold">.</span>invoke([<span style="color:#9ece6a">&#39;snapshot&#39;</span>, <span style="color:#9ece6a">&#39;--project-dir&#39;</span>, <span style="color:#9ece6a">&#39;jaffle_shop&#39;</span>, <span style="color:#9ece6a">&#39;--profiles-dir&#39;</span>, <span style="color:#9ece6a">&#39;jaffle_shop&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>conn <span style="color:#9ece6a;font-weight:bold">=</span> duckdb<span style="color:#9ece6a;font-weight:bold">.</span>connect(<span style="color:#9ece6a">&#39;warehouse.duckdb&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#414868;font-style:italic"># 이력이 생성된 고객 확인</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#9ece6a;font-weight:bold">.</span>execute(<span style="color:#9ece6a">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">SELECT customer_id, city, membership_grade,
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">       dbt_valid_from, dbt_valid_to
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">FROM snapshots.snap_customers
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">WHERE customer_id IN (1, 2, 3)
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">ORDER BY customer_id, dbt_valid_from
</span></span></span><span style="display:flex;"><span><span style="color:#9ece6a">&#34;&#34;&#34;</span>)<span style="color:#9ece6a;font-weight:bold">.</span>fetchdf()
</span></span></code></pre></div><p>customer_id = 1인 고객에 행이 두 개 생겼다. 첫 번째 행의 <code>dbt_valid_to</code>가 채워졌고, 두 번째 행이 현재 유효한 행이다. SQL 한 줄 안 쓰고 Type 2가 구현됐다.</p>
<h3 id="check-전략">check 전략<a hidden class="anchor" aria-hidden="true" href="#check-전략">#</a></h3>
<p><code>updated_at</code> 컬럼이 없는 소스도 있다. <a href="https://biz-agentic-ai.github.io/guides/etl-design/002-bronze-layer/">2편</a>에서 언급했듯, 데이터를 UPDATE하면서 <code>updated_at</code>을 안 바꾸는 시스템이 의외로 많다.</p>
<p>이런 경우 <code>check</code> 전략을 쓴다. 지정한 컬럼의 값이 바뀌었는지 직접 비교한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#9ece6a;font-weight:bold">%%</span>writefile jaffle_shop<span style="color:#9ece6a;font-weight:bold">/</span>snapshots<span style="color:#9ece6a;font-weight:bold">/</span>snap_customers_check<span style="color:#9ece6a;font-weight:bold">.</span>sql
</span></span><span style="display:flex;"><span>{<span style="color:#9ece6a;font-weight:bold">%</span> snapshot snap_customers_check <span style="color:#9ece6a;font-weight:bold">%</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{
</span></span><span style="display:flex;"><span>    config(
</span></span><span style="display:flex;"><span>        target_schema<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;snapshots&#39;</span>,
</span></span><span style="display:flex;"><span>        unique_key<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;customer_id&#39;</span>,
</span></span><span style="display:flex;"><span>        strategy<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;check&#39;</span>,
</span></span><span style="display:flex;"><span>        check_cols<span style="color:#9ece6a;font-weight:bold">=</span>[<span style="color:#9ece6a">&#39;city&#39;</span>, <span style="color:#9ece6a">&#39;membership_grade&#39;</span>]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>select
</span></span><span style="display:flex;"><span>    customer_id,
</span></span><span style="display:flex;"><span>    first_name,
</span></span><span style="display:flex;"><span>    last_name,
</span></span><span style="display:flex;"><span>    city,
</span></span><span style="display:flex;"><span>    membership_grade
</span></span><span style="display:flex;"><span><span style="color:#7dcfff">from</span> <span style="color:#e0af68">bronze.customers_v2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#9ece6a;font-weight:bold">%</span> endsnapshot <span style="color:#9ece6a;font-weight:bold">%</span>}
</span></span></code></pre></div><p><code>check_cols=['city', 'membership_grade']</code> -이 두 컬럼의 값이 이전과 다르면 변경으로 판단한다. <code>updated_at</code>이 필요 없다. 대신 매번 전체 행을 비교하므로 데이터가 크면 timestamp 전략보다 느리다.</p>
<h2 id="snapshot을-silvergold와-연결한다">snapshot을 Silver/Gold와 연결한다<a hidden class="anchor" aria-hidden="true" href="#snapshot을-silvergold와-연결한다">#</a></h2>
<p>snapshot은 Bronze도 Silver도 아닌 별도 스키마(<code>snapshots</code>)에 저장된다. 메달리온 아키텍처에서 이 위치를 정리하면 이렇다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>소스 → [Bronze] → [Silver] → [Gold]
</span></span><span style="display:flex;"><span>                      ↑
</span></span><span style="display:flex;"><span>         Bronze → [Snapshot] ──┘
</span></span></code></pre></div><p><a href="https://biz-agentic-ai.github.io/guides/etl-design/001-medallion-architecture/">1편</a>에서 정의한 레이어 구조에 snapshot이 추가된 형태다. snapshot은 Bronze 데이터를 직접 바라보고, Silver나 Gold 모델이 snapshot 결과를 참조한다.</p>
<p>Silver 모델에서 snapshot을 참조하는 구조는 이렇다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#9ece6a;font-weight:bold">%%</span>writefile jaffle_shop<span style="color:#9ece6a;font-weight:bold">/</span>models<span style="color:#9ece6a;font-weight:bold">/</span>staging<span style="color:#9ece6a;font-weight:bold">/</span>stg_customers_hist<span style="color:#9ece6a;font-weight:bold">.</span>sql
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">with</span> source <span style="color:#bb9af7">as</span> (
</span></span><span style="display:flex;"><span>    select <span style="color:#9ece6a;font-weight:bold">*</span> <span style="color:#7dcfff">from</span> {{ ref(<span style="color:#9ece6a">&#39;snap_customers&#39;</span>) }}
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cleaned <span style="color:#bb9af7">as</span> (
</span></span><span style="display:flex;"><span>    select
</span></span><span style="display:flex;"><span>        customer_id,
</span></span><span style="display:flex;"><span>        first_name,
</span></span><span style="display:flex;"><span>        last_name,
</span></span><span style="display:flex;"><span>        city,
</span></span><span style="display:flex;"><span>        membership_grade,
</span></span><span style="display:flex;"><span>        dbt_valid_from AS valid_from,
</span></span><span style="display:flex;"><span>        coalesce(dbt_valid_to, <span style="color:#9ece6a">&#39;9999-12-31&#39;</span>::timestamp) AS valid_to,
</span></span><span style="display:flex;"><span>        dbt_valid_to IS NULL AS is_current
</span></span><span style="display:flex;"><span>    <span style="color:#7dcfff">from</span> <span style="color:#e0af68">source</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>select <span style="color:#9ece6a;font-weight:bold">*</span> <span style="color:#7dcfff">from</span> <span style="color:#e0af68">cleaned</span>
</span></span></code></pre></div><p>dbt의 <code>dbt_valid_from</code>/<code>dbt_valid_to</code>를 <code>valid_from</code>/<code>valid_to</code>로 이름을 바꾸고, NULL을 <code>9999-12-31</code>로 변환했다. Gold에서 <code>BETWEEN</code> 조인을 걸 때 편하다.</p>
<p>Gold 팩트 테이블에서 시점 조인하면 이렇게 된다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#414868;font-style:italic">-- Gold: 주문 시점의 고객 정보로 조인
</span></span></span><span style="display:flex;"><span><span style="color:#bb9af7">select</span>
</span></span><span style="display:flex;"><span>    o.order_id,
</span></span><span style="display:flex;"><span>    o.order_date,
</span></span><span style="display:flex;"><span>    <span style="color:#bb9af7">c</span>.city <span style="color:#bb9af7">AS</span> city_at_order,
</span></span><span style="display:flex;"><span>    <span style="color:#bb9af7">c</span>.membership_grade <span style="color:#bb9af7">AS</span> grade_at_order
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">from</span> stg_orders o
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">join</span> stg_customers_hist <span style="color:#bb9af7">c</span>
</span></span><span style="display:flex;"><span>  <span style="color:#bb9af7">on</span> o.customer_id <span style="color:#9ece6a;font-weight:bold">=</span> <span style="color:#bb9af7">c</span>.customer_id
</span></span><span style="display:flex;"><span> <span style="color:#bb9af7">and</span> o.order_date <span style="color:#9ece6a;font-weight:bold">&gt;=</span> <span style="color:#bb9af7">c</span>.valid_from
</span></span><span style="display:flex;"><span> <span style="color:#bb9af7">and</span> o.order_date <span style="color:#9ece6a;font-weight:bold">&lt;</span> <span style="color:#bb9af7">c</span>.valid_to
</span></span></code></pre></div><h2 id="scd-적용-패턴-정리">SCD 적용 패턴 정리<a hidden class="anchor" aria-hidden="true" href="#scd-적용-패턴-정리">#</a></h2>
<table>
  <thead>
      <tr>
          <th>패턴</th>
          <th>적용 대상</th>
          <th>구현 방법</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Type 1 (덮어쓰기)</td>
          <td>오타, 코드 설명, 전화번호</td>
          <td>단순 UPDATE</td>
      </tr>
      <tr>
          <td>Type 2 (이력 추가)</td>
          <td>주소, 등급, 소속 부서</td>
          <td>dbt snapshot (timestamp / check)</td>
      </tr>
      <tr>
          <td>Type 3 (이전 값 보존)</td>
          <td>조직 개편 전후 비교</td>
          <td>previous_ 컬럼 추가</td>
      </tr>
      <tr>
          <td>혼합</td>
          <td>하나의 테이블 내 컬럼별 구분</td>
          <td>Type 1 + Type 2 병행</td>
      </tr>
  </tbody>
</table>
<p>실무에서는 Type 2가 압도적이다. dbt snapshot이 알아서 처리해주니까 구현 부담도 크지 않다. Type 1은 이력이 필요 없는 속성에 한해서, Type 3은 직전 값만 필요한 드문 경우에 쓴다.</p>
<h2 id="실무-참고-airflow에서-dbt-snapshot-실행">실무 참고: Airflow에서 dbt snapshot 실행<a hidden class="anchor" aria-hidden="true" href="#실무-참고-airflow에서-dbt-snapshot-실행">#</a></h2>
<p><a href="https://biz-agentic-ai.github.io/guides/etl-design/003-silver-layer/">3편</a>에서 Airflow DAG로 <code>dbt run</code> → <code>dbt test</code> 순서를 잡았다. snapshot이 추가되면 순서가 바뀐다.</p>
<div class="highlight"><pre tabindex="0" style="color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7dcfff">from</span> <span style="color:#e0af68">airflow</span> <span style="color:#7dcfff">import</span> DAG
</span></span><span style="display:flex;"><span><span style="color:#7dcfff">from</span> <span style="color:#e0af68">airflow.operators.bash</span> <span style="color:#7dcfff">import</span> BashOperator
</span></span><span style="display:flex;"><span><span style="color:#7dcfff">from</span> <span style="color:#e0af68">datetime</span> <span style="color:#7dcfff">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bb9af7">with</span> DAG(
</span></span><span style="display:flex;"><span>    dag_id<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;medallion_with_snapshot&#39;</span>,
</span></span><span style="display:flex;"><span>    schedule<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;0 6 * * *&#39;</span>,
</span></span><span style="display:flex;"><span>    start_date<span style="color:#9ece6a;font-weight:bold">=</span>datetime(<span style="color:#e0af68">2026</span>, <span style="color:#e0af68">1</span>, <span style="color:#e0af68">1</span>),
</span></span><span style="display:flex;"><span>    catchup<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#e0af68">False</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#bb9af7">as</span> dag:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#414868;font-style:italic"># 1. snapshot 먼저 실행 -Bronze의 변경 이력을 캡처</span>
</span></span><span style="display:flex;"><span>    run_snapshot <span style="color:#9ece6a;font-weight:bold">=</span> BashOperator(
</span></span><span style="display:flex;"><span>        task_id<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;dbt_snapshot&#39;</span>,
</span></span><span style="display:flex;"><span>        bash_command<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;cd /opt/dbt/jaffle_shop &amp;&amp; dbt snapshot&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#414868;font-style:italic"># 2. Silver 변환 -snapshot 결과를 참조하는 모델이 있으니까</span>
</span></span><span style="display:flex;"><span>    run_staging <span style="color:#9ece6a;font-weight:bold">=</span> BashOperator(
</span></span><span style="display:flex;"><span>        task_id<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;dbt_run_staging&#39;</span>,
</span></span><span style="display:flex;"><span>        bash_command<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;cd /opt/dbt/jaffle_shop &amp;&amp; dbt run --select staging&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#414868;font-style:italic"># 3. Gold 변환</span>
</span></span><span style="display:flex;"><span>    run_marts <span style="color:#9ece6a;font-weight:bold">=</span> BashOperator(
</span></span><span style="display:flex;"><span>        task_id<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;dbt_run_marts&#39;</span>,
</span></span><span style="display:flex;"><span>        bash_command<span style="color:#9ece6a;font-weight:bold">=</span><span style="color:#9ece6a">&#39;cd /opt/dbt/jaffle_shop &amp;&amp; dbt run --select marts&#39;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    run_snapshot <span style="color:#9ece6a;font-weight:bold">&gt;&gt;</span> run_staging <span style="color:#9ece6a;font-weight:bold">&gt;&gt;</span> run_marts
</span></span></code></pre></div><p>핵심은 <code>run_snapshot &gt;&gt; run_staging</code> 순서다. Silver 모델 중 <code>stg_customers_hist</code>가 <code>snap_customers</code>를 참조한다. snapshot이 먼저 실행되어야 Silver가 최신 이력을 반영할 수 있다. snapshot을 Silver 뒤에 돌리면 이번 배치에서 감지된 변경이 다음 배치에서야 Silver에 반영된다. 하루 늦는다.</p>
<p>다음 글에서는 Gold 레이어를 다룬다. Silver에서 정제한 데이터와 snapshot 이력을 합쳐서 팩트·차원 테이블을 구성하는 과정이다. dbt <code>marts</code> 디렉토리가 본격적으로 등장한다.</p>
<div style="margin: 1.2em 0;">
  <a href="https://colab.research.google.com/github/biz-agentic-ai/biz-agentic-ai.github.io/blob/main/notebooks/etl-004-scd.ipynb" target="_blank" rel="noopener noreferrer"
     style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            background: linear-gradient(135deg, #f9ab00 0%, #f57c00 100%);
            color: #fff; text-decoration: none; border-radius: 8px;
            font-weight: 600; font-size: 0.95em;
            box-shadow: 0 2px 8px rgba(245,124,0,0.25);
            transition: all 0.2s ease;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="white"/>
    </svg>
    Google Colab에서 실습하기
  </a>
</div>



  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://biz-agentic-ai.github.io/tags/etl/">Etl</a></li>
      <li><a href="https://biz-agentic-ai.github.io/tags/scd/">Scd</a></li>
      <li><a href="https://biz-agentic-ai.github.io/tags/dbt-snapshot/">Dbt-Snapshot</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://biz-agentic-ai.github.io/guides/etl-design/003-silver-layer/">
    <span class="title">« 이전 페이지</span>
    <br>
    <span>3. Silver 레이어 - Bronze를 분석 가능한 상태로 올린다</span>
  </a>
</nav>

  </footer>
<div class="comments">
  <script src="https://giscus.app/client.js"
    data-repo="biz-agentic-ai/biz-agentic-ai.github.io"
    data-repo-id="R_kgDOPhm8OQ"
    data-category="General"
    data-category-id="DIC_kwDOPhm8Oc4C2uES"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="ko"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
</div>

</article>
        </main>
        
<footer class="footer">
        <span>&copy; 2026 <a href="https://biz-agentic-ai.github.io/">Junho Lee | DataNexus 구축 과정</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '복사';

        function copyingDone() {
            copybutton.innerHTML = '복사 완료!';
            setTimeout(() => {
                copybutton.innerHTML = '복사';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</div>
    <script>
    (function() {
        const toggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (toggle && sidebar) {
            toggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            });
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            });
        }
    })();
    </script>
</body>

</html>
